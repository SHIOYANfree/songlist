<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã—ãŠã‚„ã‚“ã®å¼¾èªã‚Šãƒªã‚¹ãƒˆ</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --ink:#e7eaf0; --muted:#a9b1c6;
      --link:#8dd1ff; --btn:#20283a; --btn-hover:#2a3450; --border:#2b3242; --chip:#1e2430;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP','Hiragino Kaku Gothic ProN','Yu Gothic UI',sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.82));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 8px}
    .sub{color:var(--muted);font-size:12px}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px;align-items:center}
    .row2{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .chk{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px}
    .badge{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--ink);padding:8px 12px;border-radius:10px;font-size:12px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:var(--btn-hover)}
    .btn.small{padding:4px 8px;font-size:11px}
    .toolbar input[type="search"]{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--ink);outline:none}
    .toolbar input[type="search"]::placeholder{color:var(--muted)}
    .table{max-width:1100px;margin:16px auto;padding:0 16px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
    thead{display:none} /* è¦‹å‡ºã—ã¯éè¡¨ç¤ºï¼ˆæœ€ä¸Šæ®µãŒéš ã‚Œãªã„ã‚ˆã†ã«ï¼‰ */
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#181d29}
    .song a.title{color:var(--link);text-decoration:none}
    .song a.title:hover{text-decoration:underline}
    .providers{display:flex;flex-wrap:wrap;gap:6px}
    .tag{display:inline-block;background:#1a2130;border:1px solid var(--border);padding:2px 6px;border-radius:7px;font-size:11px;color:var(--muted)}
    .count{font-size:12px;color:var(--muted);margin-left:auto}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .foot{color:var(--muted);font-size:12px;margin-top:12px}
    .codeurl a{color:#bfead1}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ã—ãŠã‚„ã‚“ã®å¼¾èªã‚Šãƒªã‚¹ãƒˆ</h1>
      <div class="sub">ç©ºç™½åŒºåˆ‡ã‚Šã®<strong>ANDæ¤œç´¢</strong>ï¼<strong>çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿</strong>ï¼ˆå¯¾å¿œå¯/ç·´ç¿’ä¸­/ä¼´å¥ã®ã¿ï¼‰ï¼<strong>æ›²åã‚¯ãƒªãƒƒã‚¯ï¼ã‚³ãƒ¼ãƒ‰URLç›´è¡Œ</strong>ï¼ˆURLã‚ã‚Šã®ã¿ï¼‰ï¼ã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤º</div>

      <div class="toolbar">
        <input id="q" autocomplete="off" type="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šå¤ æ¶™ãã†ãã† / Mrs. GREEN APPLE / Key:G ãªã©ï¼‰" />
        <span id="resultCount" class="badge">èª­ã¿è¾¼ã¿ä¸­â€¦</span>

        <div class="row2">
          <div class="filters">
            <label class="chk"><input type="checkbox" id="st_ok" checked>å¯¾å¿œå¯</label>
            <label class="chk"><input type="checkbox" id="st_wip">ç·´ç¿’ä¸­</label>
            <label class="chk"><input type="checkbox" id="st_ba">ä¼´å¥ã®ã¿</label>
          </div>
          <button id="sortTitle" class="btn">æ›²å Aâ†’Z</button>
          <button id="sortArtist" class="btn">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ Aâ†’Z</button>
          <a class="btn" href="#request">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹</a>
          <span class="badge">CSVã¯ <code>songs.csv</code></span>
          <span class="count" id="csvName"></span>
        </div>
      </div>
    </div>
  </header>

  <section class="table">
    <table>
      <thead>
        <tr>
          <th>No.</th><th>æ›²å</th><th>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</th><th>ã‚­ãƒ¼</th><th>çŠ¶æ…‹</th><th>ã‚³ãƒ¼ãƒ‰URL</th><th>ã‚³ãƒ¼ãƒ‰æ¤œç´¢</th><th>ãƒ¡ãƒ¢</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="8" class="muted" style="padding:20px">CSVã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</td></tr>
      </tbody>
    </table>
    <div class="foot">
      CSVåˆ—åã®ä¾‹ï¼š<code>æ›²å,ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ,ã‚­ãƒ¼,çŠ¶æ…‹,ã‚¸ãƒ£ãƒ³ãƒ«,å‚™è€ƒ,ã‚³ãƒ¼ãƒ‰URL</code>ï¼ˆç„¡ãã¦ã‚‚OKã€‚ã‚ã‚‹ã‚‚ã®ã ã‘è‡ªå‹•åˆ¤å®šï¼‰
    </div>
  </section>

  <!-- ğŸµ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‹Ÿé›†ãƒ•ã‚©ãƒ¼ãƒ  -->
  <section id="request" style="max-width:1100px;margin:32px auto;padding:0 16px">
    <h2>ğŸµ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‹Ÿé›†</h2>
    <p class="muted">å¼¾ã„ã¦ã»ã—ã„æ›²ãŒã‚ã‚Œã°ã€ã“ã¡ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ã£ã¦ãã ã•ã„ã€‚</p>
    <iframe
      src="https://docs.google.com/forms/d/e/1FAIpQLSc_7e3Ihrz-KgMUAFa5VAve-1Ag41elJC9XhhKRKbuCIt09-Q/viewform?embedded=true"
      width="100%" height="900" frameborder="0" marginheight="0" marginwidth="0">
      èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦
    </iframe>
    <p style="margin-top:8px;">
      <a class="btn"
         href="https://docs.google.com/forms/d/e/1FAIpQLSc_7e3Ihrz-KgMUAFa5VAve-1Ag41elJC9XhhKRKbuCIt09-Q/viewform?usp=dialog"
         target="_blank" rel="noopener noreferrer">
        æ–°ã—ã„ã‚¿ãƒ–ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
      </a>
    </p>
  </section>

  <script>
    // ========= è¨­å®š =========
    const CSV_PATH = 'songs.csv';
    document.getElementById('csvName').textContent = 'CSV: ' + CSV_PATH;

    // ã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰
    const PROVIDERS = [
      { name:'U-ãƒ•ãƒ¬ãƒƒãƒˆ', build:(t,a)=>`https://www.google.com/search?q=site:ufret.jp+${encodeURIComponent(a+' '+t)}` },
      { name:'J-Total',   build:(t,a)=>`https://www.google.com/search?q=site:music.j-total.net+${encodeURIComponent(a+' '+t)}` },
      { name:'ChordWiki', build:(t,a)=>`https://www.google.com/search?q=site:chordwiki.org+${encodeURIComponent(a+' '+t)}` },
      { name:'æ¥½å™¨.me',   build:(t,a)=>`https://www.google.com/search?q=site:gakufu.gakki.me+${encodeURIComponent(a+' '+t)}` },
    ];

    // ========= æ­£è¦åŒ–ï¼ˆæ¤œç´¢å¼·åŒ–ï¼šå…¨è§’/åŠè§’ãƒ»ã²ã‚‰/ã‚«ãƒŠçµ±ä¸€ï¼‰ =========
    function norm(s){
      return String(s || '')
        .normalize('NFKC')
        .toLowerCase()
        .replace(/[ã-ã‚–]/g, ch => String.fromCharCode(ch.charCodeAt(0) + 0x60)); // ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠ
    }

    // ========= CSVãƒ‘ãƒ¼ã‚µ =========
    function parseCSV(txt){
      const rows=[]; let i=0, s=txt, L=s.length, cur=[], field='', inQ=false;
      const pushF=()=>{cur.push(field); field='';}, pushR=()=>{rows.push(cur); cur=[];};
      while(i<L){
        const c=s[i];
        if(inQ){
          if(c==='\"'){ if(i+1<L && s[i+1]==='\"'){ field+='\"'; i++; } else inQ=false; }
          else field+=c;
        }else{
          if(c===',') pushF();
          else if(c==='\n'){ pushF(); pushR(); }
          else if(c==='\r'){}
          else if(c==='\"') inQ=true;
          else field+=c;
        }
        i++;
      }
      pushF(); if(cur.length) pushR();

      const header = rows.shift() || [];
      const idx={}; header.forEach((h,j)=>idx[h.trim()]=j);

      function findIdx(cands){
        for(const k of cands){
          if(idx[k]!=null) return idx[k];
          const low = Object.keys(idx).find(x=>x.toLowerCase()===k.toLowerCase());
          if(low) return idx[low];
        }
        return -1;
      }

      const I = {
        title:  findIdx(['æ›²å','ã‚¿ã‚¤ãƒˆãƒ«','title']),
        artist: findIdx(['ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ','æ­Œæ‰‹','artist']),
        key:    findIdx(['ã‚­ãƒ¼','key','èª¿']),
        state:  findIdx(['çŠ¶æ…‹','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','status']),
        genre:  findIdx(['ã‚¸ãƒ£ãƒ³ãƒ«','genre']),
        code:   findIdx(['ã‚³ãƒ¼ãƒ‰URL','ã‚³ãƒ¼ãƒ‰','code','ã‚³ãƒ¼ãƒ‰Url']),
        memo:   findIdx(['ãƒ¡ãƒ¢','å‚™è€ƒ','note','memo']),   // â† å‚™è€ƒã‚‚æ‹¾ã†
      };

      return rows
        .filter(r=>r.length>1 && r.some(c=>(c||'').trim()!==''))
        .map(r=>({
          title:  I.title>=0  ? (r[I.title]||'').trim()  : '',
          artist: I.artist>=0 ? (r[I.artist]||'').trim() : '',
          key:    I.key>=0    ? (r[I.key]||'').trim()    : '',
          state:  I.state>=0  ? (r[I.state]||'').trim()  : 'å¯¾å¿œå¯',
          genre:  I.genre>=0  ? (r[I.genre]||'').trim()  : '',
          code:   I.code>=0   ? (r[I.code]||'').trim()   : '',
          memo:   I.memo>=0   ? (r[I.memo]||'').trim()   : '',
        }));
    }

    // ========= DOM & çŠ¶æ…‹ =========
    const $q=document.getElementById('q'), $tbody=document.getElementById('tbody'), $count=document.getElementById('resultCount');
    const $st_ok=document.getElementById('st_ok'), $st_wip=document.getElementById('st_wip'), $st_ba=document.getElementById('st_ba');
    const $sortTitle=document.getElementById('sortTitle'), $sortArtist=document.getElementById('sortArtist');

    let sortKey=null, sortDir='asc';
    function toggleSort(which){
      if(sortKey!==which){ sortKey=which; sortDir='asc'; }
      else{ sortDir = (sortDir==='asc'?'desc':'asc'); }
      $sortTitle.textContent  = 'æ›²å ' + (sortKey==='title'  && sortDir==='desc' ? 'Zâ†’A' : 'Aâ†’Z');
      $sortArtist.textContent = 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ' + (sortKey==='artist'&& sortDir==='desc' ? 'Zâ†’A' : 'Aâ†’Z');
      render(filterApply(ALL));
    }

    function makeProviderButtons(t,a){
      const w=document.createElement('div'); w.className='providers';
      PROVIDERS.forEach(p=>{
        const x=document.createElement('a');
        x.className='btn small'; x.href=p.build(t,a); x.target='_blank'; x.rel='noopener noreferrer';
        x.textContent=p.name; w.appendChild(x);
      });
      return w;
    }

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    // ========= çµã‚Šè¾¼ã¿ =========
    function activeStates(){
      const s=[];
      if($st_ok.checked) s.push('å¯¾å¿œå¯');
      if($st_wip.checked) s.push('ç·´ç¿’ä¸­');
      if($st_ba.checked)  s.push('ä¼´å¥ã®ã¿');
      return s;
    }

    function filterApply(all){
      const terms = norm($q.value).trim().split(/\s+/).filter(Boolean);
      const states = activeStates();

      return all.filter(r=>{
        if(states.length && !states.includes((r.state||'å¯¾å¿œå¯'))) return false;
        if(terms.length===0) return true;

        // æ¤œç´¢å¯¾è±¡ï¼šæ›²å/ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ/ã‚­ãƒ¼/çŠ¶æ…‹/ã‚¸ãƒ£ãƒ³ãƒ«/å‚™è€ƒ
        const hay = norm([r.title, r.artist, r.key, r.state, r.genre, r.memo].join(' '));
        return terms.every(t => hay.includes(t));
      });
    }

    // ========= æç”» =========
    function render(list){
      const data = sortKey ? [...list].sort((a,b)=>{
        const A=(a[sortKey]||'').toLowerCase(), B=(b[sortKey]||'').toLowerCase();
        const cmp = A.localeCompare(B,'ja');
        return sortDir==='asc' ? cmp : -cmp;
      }) : list;

      $tbody.innerHTML='';
      if(data.length===0){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=8; td.className='muted'; td.style.padding='20px'; td.textContent='æ¡ä»¶ã«åˆã†æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        tr.appendChild(td); $tbody.appendChild(tr);
      }else{
        data.forEach((r,i)=>{
          const tr=document.createElement('tr');

          const tdNo=document.createElement('td'); tdNo.textContent=String(i+1); tr.appendChild(tdNo);

          const tdT=document.createElement('td'); tdT.className='song';
          if(r.code){
            const a=document.createElement('a'); a.href=r.code; a.target='_blank'; a.rel='noopener noreferrer'; a.className='title';
            a.textContent=r.title||'(ç„¡é¡Œ)'; tdT.appendChild(a);
          }else{ tdT.textContent=r.title||'(ç„¡é¡Œ)'; }
          tr.appendChild(tdT);

          const tdA=document.createElement('td'); tdA.textContent=r.artist; tr.appendChild(tdA);

          const tdK=document.createElement('td'); tdK.className='nowrap';
          tdK.innerHTML=r.key?`<span class="tag">Key: ${escapeHtml(r.key)}</span>`:''; tr.appendChild(tdK);

          const tdS=document.createElement('td'); tdS.className='nowrap';
          tdS.innerHTML=r.state?`<span class="tag">${escapeHtml(r.state)}</span>`:''; tr.appendChild(tdS);

          const tdC=document.createElement('td'); tdC.className='codeurl';
          if(r.code){ const a=document.createElement('a'); a.href=r.code; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent='é–‹ã'; tdC.appendChild(a); }
          else tdC.innerHTML='<span class="muted">â€”</span>';
          tr.appendChild(tdC);

          const tdSearch=document.createElement('td'); tdSearch.appendChild(makeProviderButtons(r.title,r.artist)); tr.appendChild(tdSearch);

          const tdM=document.createElement('td'); tdM.textContent=r.memo||''; tr.appendChild(tdM);

          $tbody.appendChild(tr);
        });
      }
      $count.textContent = `è¡¨ç¤ºä»¶æ•°ï¼š${data.length}`;
    }

    // ========= èµ·å‹• =========
    let ALL=[];
    async function boot(){
      $q.value=''; // åˆæœŸã¯ç©º
      try{
        const res=await fetch(CSV_PATH,{cache:'no-store'}); if(!res.ok) throw new Error('CSVå–å¾—å¤±æ•—');
        const txt=await res.text(); ALL=parseCSV(txt);
      }catch(e){
        ALL=[];
        $tbody.innerHTML=`<tr><td colspan="8" class="muted" style="padding:20px">CSVã€Œ${CSV_PATH}ã€ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>`;
        $count.textContent='è¡¨ç¤ºä»¶æ•°ï¼š0'; return;
      }
      render(filterApply(ALL));
    }

    [$q,$st_ok,$st_wip,$st_ba].forEach(el=>el.addEventListener('input',()=>render(filterApply(ALL))));
    document.getElementById('sortTitle').addEventListener('click',()=>toggleSort('title'));
    document.getElementById('sortArtist').addEventListener('click',()=>toggleSort('artist'));
    boot();
  </script>
</body>
</html>
