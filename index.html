<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>しおやんの弾語りリスト</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --ink:#e7eaf0; --muted:#a9b1c6;
      --accent:#5fa8ff; --chip:#1e2430; --ok:#27ae60; --warn:#f39c12;
      --link:#8dd1ff; --btn:#20283a; --btn-hover:#2a3450; --border:#2b3242;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP','Hiragino Kaku Gothic ProN','Yu Gothic UI',sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.8));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 8px}
    .sub{color:var(--muted);font-size:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .toolbar input[type="search"]{flex:1 1 260px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--ink);outline:none}
    .toolbar input[type="search"]::placeholder{color:var(--muted)}
    .badge{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .table{max-width:1100px;margin:16px auto;padding:0 16px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
    thead th{position:sticky;top:64px;background:var(--panel);z-index:5;text-align:left;font-size:12px;color:var(--muted);padding:10px;border-bottom:1px solid var(--border)}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#181d29}
    .song a.title{color:var(--link);text-decoration:none}
    .song a.title:hover{text-decoration:underline}
    .providers{display:flex;flex-wrap:wrap;gap:6px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--ink);padding:6px 10px;border-radius:10px;font-size:12px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:var(--btn-hover)}
    .btn.small{padding:4px 8px;font-size:11px}
    .tag{display:inline-block;background:#1a2130;border:1px solid var(--border);padding:2px 6px;border-radius:7px;font-size:11px;color:var(--muted)}
    .count{font-size:12px;color:var(--muted);margin-left:auto}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .foot{color:var(--muted);font-size:12px;margin-top:12px}
    .codeurl a{color:#bfead1}
    @media (max-width:740px){
      thead th:nth-child(1), tbody td:nth-child(1){display:none} /* No. を隠す */
      thead th:nth-child(5), tbody td:nth-child(5){display:none} /* コードURL列を隠す（曲名クリック誘導） */
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>しおやんの弾語りリスト</h1>
      <div class="sub">空白区切りの <strong>AND検索</strong> に対応（曲名・アーティスト・キー・メモを横断）／
        <strong>曲名クリック＝コードURLへ直行</strong>（URLがある曲のみ）／
        コード検索ボタンは常に表示
      </div>
      <div class="toolbar">
        <input id="q" type="search" placeholder="キーワード（例：夏 涙そうそう / Mrs. GREEN APPLE / Key:G など）" />
        <span id="resultCount" class="badge">読み込み中…</span>
        <span class="badge">CSV指定は <code>?csv=ファイル名.csv</code></span>
        <span class="count" id="csvName"></span>
      </div>
    </div>
  </header>

  <section class="table">
    <table>
      <thead>
        <tr>
          <th class="nowrap">No.</th>
          <th>曲名</th>
          <th>アーティスト</th>
          <th class="nowrap">キー</th>
          <th>コードURL</th>
          <th>コード検索</th>
          <th>メモ</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="muted" style="padding:20px">CSVを読み込み中です…</td></tr>
      </tbody>
    </table>
    <div class="foot">
      CSVの列名例：<code>曲名,アーティスト,キー,コードURL,メモ</code>（順不同でもOK）。  
      例：<code>涙そうそう,夏川りみ,G,https://example.com/chord,定番</code>
    </div>
  </section>

  <script>
    // ============ 設定 ============
    const CSV_PATH = new URLSearchParams(location.search).get('csv') || 'songs.csv';
    document.getElementById('csvName').textContent = 'CSV: ' + CSV_PATH;

    // コード検索プロバイダ（常時表示）
    // ※各サイトの内部検索仕様に左右されないよう、安定の Google site: 検索でリンクを作ります。
    const PROVIDERS = [
      { name: 'U-フレット', build: (title, artist) =>
          `https://www.google.com/search?q=site:ufret.jp+${encodeURIComponent(artist + ' ' + title)}` },
      { name: 'J-Total', build: (title, artist) =>
          `https://www.google.com/search?q=site:music.j-total.net+${encodeURIComponent(artist + ' ' + title)}` },
      { name: 'ChordWiki', build: (title, artist) =>
          `https://www.google.com/search?q=site:chordwiki.org+${encodeURIComponent(artist + ' ' + title)}` },
      // ★ 追加要件：楽器.me（gakufu.gakki.me）
      { name: '楽器.me', build: (title, artist) =>
          `https://www.google.com/search?q=site:gakufu.gakki.me+${encodeURIComponent(artist + ' ' + title)}` },
    ];

    // ============ CSV パーサ（RFC4180 対応の簡易版） ============
    function parseCSV(csvText){
      const rows = [];
      let i=0, s=csvText, len=s.length, cur=[], field='', inQuotes=false;
      function pushField(){ cur.push(field); field=''; }
      function pushRow(){ rows.push(cur); cur=[]; }
      while(i<len){
        const c=s[i];
        if(inQuotes){
          if(c==='\"'){
            if(i+1<len && s[i+1]==='\"'){ field+='\"'; i++; } // エスケープされた二重引用符
            else{ inQuotes=false; }
          } else {
            field+=c;
          }
        } else {
          if(c===','){ pushField(); }
          else if(c==='\n'){ pushField(); pushRow(); }
          else if(c==='\r'){ /* ignore CR */ }
          else if(c==='\"'){ inQuotes=true; }
          else { field+=c; }
        }
        i++;
      }
      // 最終フィールド
      pushField();
      // 末尾に空行が無ければ行確定
      if(cur.length){ pushRow(); }
      // 先頭行＝ヘッダ
      const header = rows.shift() || [];
      // ヘッダのインデックス辞書（柔軟に対応）
      const idx = {};
      header.forEach((h, j) => idx[h.trim()] = j);

      // 想定列が無い場合のため、一応小文字や全角半角ゆらぎも見る
      function findIdx(candidates){
        for(const key of candidates){
          if(idx[key] != null) return idx[key];
          // ゆらぎ（小文字）
          const lowKey = Object.keys(idx).find(k => k.toLowerCase() === key.toLowerCase());
          if(lowKey) return idx[lowKey];
        }
        return -1;
      }

      const I = {
        title: findIdx(['曲名','タイトル','title']),
        artist: findIdx(['アーティスト','歌手','artist']),
        key: findIdx(['キー','key','調']),
        code: findIdx(['コードURL','コード','code','コードUrl']),
        memo: findIdx(['メモ','備考','note','memo']),
      };

      const data = rows
        .filter(r => r.length>1 && r.some(c => (c||'').trim()!==''))
        .map(r => ({
          title: I.title>=0 ? (r[I.title]||'').trim() : '',
          artist: I.artist>=0 ? (r[I.artist]||'').trim() : '',
          key: I.key>=0 ? (r[I.key]||'').trim() : '',
          code: I.code>=0 ? (r[I.code]||'').trim() : '',
          memo: I.memo>=0 ? (r[I.memo]||'').trim() : '',
        }));
      return data;
    }

    // ============ 描画 ============
    const $q = document.getElementById('q');
    const $tbody = document.getElementById('tbody');
    const $count = document.getElementById('resultCount');

    function makeProviderButtons(title, artist){
      const wrap = document.createElement('div');
      wrap.className = 'providers';
      PROVIDERS.forEach(p => {
        const a = document.createElement('a');
        a.className = 'btn small';
        a.href = p.build(title, artist);
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.title = `${p.name}で「${artist} ${title}」を検索`;
        a.textContent = p.name;
        wrap.appendChild(a);
      });
      return wrap;
    }

    function render(data){
      $tbody.innerHTML = '';
      data.forEach((row, idx) => {
        const tr = document.createElement('tr');

        // No.
        const tdNo = document.createElement('td');
        tdNo.textContent = String(idx+1);
        tr.appendChild(tdNo);

        // 曲名（コードURLがあればクリックで直行）
        const tdTitle = document.createElement('td');
        tdTitle.className = 'song';
        if(row.code){
          const a = document.createElement('a');
          a.href = row.code;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'title';
          a.textContent = row.title || '(無題)';
          tdTitle.appendChild(a);
        }else{
          const span = document.createElement('span');
          span.textContent = row.title || '(無題)';
          tdTitle.appendChild(span);
        }
        tr.appendChild(tdTitle);

        // アーティスト
        const tdArtist = document.createElement('td');
        tdArtist.textContent = row.artist;
        tr.appendChild(tdArtist);

        // キー
        const tdKey = document.createElement('td');
        tdKey.className = 'nowrap';
        tdKey.innerHTML = row.key ? `<span class="tag">Key: ${escapeHtml(row.key)}</span>` : '';
        tr.appendChild(tdKey);

        // コードURL（存在すればリンクも表示）
        const tdCode = document.createElement('td');
        tdCode.className = 'codeurl';
        if(row.code){
          const a = document.createElement('a');
          a.href = row.code;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = '開く';
          tdCode.appendChild(a);
        }else{
          tdCode.innerHTML = '<span class="muted">—</span>';
        }
        tr.appendChild(tdCode);

        // コード検索（常に表示）
        const tdSearch = document.createElement('td');
        tdSearch.appendChild(makeProviderButtons(row.title, row.artist));
        tr.appendChild(tdSearch);

        // メモ
        const tdMemo = document.createElement('td');
        tdMemo.textContent = row.memo || '';
        tr.appendChild(tdMemo);

        $tbody.appendChild(tr);
      });
      $count.textContent = `表示件数：${data.length}`;
    }

    function filterData(all){
      const terms = ($q.value || '').trim().split(/\s+/).filter(Boolean);
      if(terms.length===0) return all;
      return all.filter(r => {
        const hay = [r.title, r.artist, r.key, r.memo].join(' ').toLowerCase();
        return terms.every(t => hay.includes(t.toLowerCase()));
      });
    }

    // HTMLエスケープ
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // ============ 起動 ============
    let ALL = [];
    async function boot(){
      try{
        const res = await fetch(CSV_PATH, {cache:'no-store'});
        if(!res.ok) throw new Error('CSV取得失敗');
        const text = await res.text();
        ALL = parseCSV(text);
        if(ALL.length===0){
          // 空ならサンプル
          ALL = [
            { title:'涙そうそう', artist:'夏川りみ', key:'G', code:'', memo:'定番' },
            { title:'ライラック', artist:'Mrs. GREEN APPLE', key:'E', code:'', memo:'' },
          ];
        }
      }catch(e){
        // 失敗時はサンプルで代替
        ALL = [
          { title:'涙そうそう', artist:'夏川りみ', key:'G', code:'', memo:'定番' },
          { title:'ライラック', artist:'Mrs. GREEN APPLE', key:'E', code:'', memo:'' },
        ];
      }
      render(filterData(ALL));
    }

    $q.addEventListener('input', () => render(filterData(ALL)));

    boot();
  </script>
</body>
</html>