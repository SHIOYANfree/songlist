<script>
// CSVをパース（クォート対応）
function parseCSV(text) {
  const rows = [];
  let row = [], cell = "", q = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      if (q && text[i+1] === '"') { cell += '"'; i++; }
      else { q = !q; }
    } else if (ch === ',' && !q) { row.push(cell); cell = ""; }
    else if ((ch === '\n' || ch === '\r') && !q) {
      if (cell !== "" || row.length) { row.push(cell); rows.push(row); }
      row = []; cell = "";
    } else { cell += ch; }
  }
  if (cell !== "" || row.length) { row.push(cell); rows.push(row); }
  return rows;
}

function renderTable(rows) {
  let html = '<tr>' + rows[0].map(h => `<th>${h}</th>`).join('') + '</tr>';
  for (let i = 1; i < rows.length; i++) {
    html += '<tr>' + rows[i].map(c => `<td>${c}</td>`).join('') + '</tr>';
  }
  document.getElementById('songTable').innerHTML = html;
}

function setupSearch(rows) {
  const box = document.getElementById('searchBox');
  box.addEventListener('input', () => {
    const kw = box.value.toLowerCase();
    const filtered = rows.filter((r, i) =>
      i === 0 || r.some(c => c.toLowerCase().includes(kw))
    );
    renderTable(filtered);
  });
}

// ★ ここがポイント：まずUTF-8でdecode。失敗したらShift-JISで再decode
fetch('弾き語り曲リスト.csv')
  .then(res => res.arrayBuffer())
  .then(buf => {
    let text;
    try {
      text = new TextDecoder('utf-8', { fatal: true }).decode(buf);
    } catch {
      text = new TextDecoder('shift_jis').decode(buf);
    }
    const rows = parseCSV(text.trim());
    renderTable(rows);
    setupSearch(rows);
  });
</script>
