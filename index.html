<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>しおやんの弾語りリスト</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --ink:#e7eaf0; --muted:#a9b1c6;
      --link:#8dd1ff; --btn:#20283a; --btn-hover:#2a3450; --border:#2b3242; --chip:#1e2430;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP','Hiragino Kaku Gothic ProN','Yu Gothic UI',sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.82));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 8px}
    .sub{color:var(--muted);font-size:12px}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px;align-items:center}
    .row2{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .chk{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px}
    .badge{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--ink);padding:8px 12px;border-radius:10px;font-size:12px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:var(--btn-hover)}
    .btn.small{padding:4px 8px;font-size:11px}
    .toolbar input[type="search"]{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--ink);outline:none}
    .toolbar input[type="search"]::placeholder{color:var(--muted)}
    .table{max-width:1100px;margin:16px auto;padding:0 16px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
    thead{display:none} /* ← 見出しを非表示にして、最上段が隠れないように */
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#181d29}
    .song a.title{color:var(--link);text-decoration:none}
    .song a.title:hover{text-decoration:underline}
    .providers{display:flex;flex-wrap:wrap;gap:6px}
    .tag{display:inline-block;background:#1a2130;border:1px solid var(--border);padding:2px 6px;border-radius:7px;font-size:11px;color:var(--muted)}
    .count{font-size:12px;color:var(--muted);margin-left:auto}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .foot{color:var(--muted);font-size:12px;margin-top:12px}
    .codeurl a{color:#bfead1}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>しおやんの弾語りリスト</h1>
      <div class="sub">空白区切りの<strong>AND検索</strong>／<strong>状態フィルタ</strong>（対応可/練習中/伴奏のみ）／<strong>曲名クリック＝コードURL直行</strong>（URLありのみ）／コード検索ボタンは常に表示</div>

      <div class="toolbar">
        <input id="q" autocomplete="off" type="search" placeholder="キーワード（例：夏 涙そうそう / Mrs. GREEN APPLE / Key:G など）" />
        <span id="resultCount" class="badge">読み込み中…</span>

        <div class="row2">
          <div class="filters">
            <label class="chk"><input type="checkbox" id="st_ok" checked>対応可</label>
            <label class="chk"><input type="checkbox" id="st_wip">練習中</label>
            <label class="chk"><input type="checkbox" id="st_ba">伴奏のみ</label>
          </div>
          <!-- 並べ替えボタン（復活） -->
          <button id="sortTitle" class="btn">曲名 A→Z</button>
          <button id="sortArtist" class="btn">アーティスト A→Z</button>

          <span class="badge">CSVは <code>songs.csv</code></span>
          <span class="count" id="csvName"></span>
        </div>
      </div>
    </div>
  </header>

  <section class="table">
    <table>
      <thead>
        <tr>
          <th>No.</th><th>曲名</th><th>アーティスト</th><th>キー</th><th>状態</th><th>コードURL</th><th>コード検索</th><th>メモ</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="8" class="muted" style="padding:20px">CSVを読み込み中です…</td></tr>
      </tbody>
    </table>
    <div class="foot">
      CSVの列名例：<code>曲名,アーティスト,キー,状態,コードURL,メモ</code>（状態が無い場合は自動で「対応可」扱い）
    </div>
  </section>

  <script>
    // ============ 設定 ============
    const CSV_PATH = 'songs.csv';
    document.getElementById('csvName').textContent = 'CSV: ' + CSV_PATH;

    // コード検索プロバイダ（常時表示）
    const PROVIDERS = [
      { name: 'U-フレット', build: (title, artist) => `https://www.google.com/search?q=site:ufret.jp+${encodeURIComponent(artist + ' ' + title)}` },
      { name: 'J-Total',   build: (title, artist) => `https://www.google.com/search?q=site:music.j-total.net+${encodeURIComponent(artist + ' ' + title)}` },
      { name: 'ChordWiki', build: (title, artist) => `https://www.google.com/search?q=site:chordwiki.org+${encodeURIComponent(artist + ' ' + title)}` },
      { name: '楽器.me',   build: (title, artist) => `https://www.google.com/search?q=site:gakufu.gakki.me+${encodeURIComponent(artist + ' ' + title)}` },
    ];

    // ============ CSV パーサ ============
    function parseCSV(csvText){
      const rows=[]; let i=0, s=csvText, len=s.length, cur=[], field='', inQ=false;
      const pushF=()=>{cur.push(field); field='';}; const pushR=()=>{rows.push(cur); cur=[];};
      while(i<len){ const c=s[i];
        if(inQ){ if(c==='\"'){ if(i+1<len && s[i+1]==='\"'){field+='\"'; i++;} else inQ=false; } else field+=c; }
        else { if(c===',') pushF(); else if(c==='\n'){ pushF(); pushR(); }
          else if(c==='\r'){} else if(c==='\"') inQ=true; else field+=c; }
        i++;
      }
      pushF(); if(cur.length) pushR();
      const header = rows.shift() || []; const idx={}; header.forEach((h,j)=>idx[h.trim()]=j);
      function findIdx(names){ for(const k of names){ if(idx[k]!=null) return idx[k];
        const low = Object.keys(idx).find(x=>x.toLowerCase()===k.toLowerCase()); if(low) return idx[low]; } return -1; }
      const I={
        title: findIdx(['曲名','タイトル','title']),
        artist: findIdx(['アーティスト','歌手','artist']),
        key: findIdx(['キー','key','調']),
        state: findIdx(['状態','ステータス','status']),
        code: findIdx(['コードURL','コード','code','コードUrl']),
        memo: findIdx(['メモ','備考','note','memo']),
      };
      return rows
        .filter(r=>r.length>1 && r.some(c=>(c||'').trim()!==''))
        .map(r=>({
          title: I.title>=0 ? (r[I.title]||'').trim() : '',
          artist:I.artist>=0? (r[I.artist]||'').trim() : '',
          key:   I.key>=0   ? (r[I.key]||'').trim() : '',
          state: I.state>=0 ? (r[I.state]||'').trim() : '対応可',
          code:  I.code>=0  ? (r[I.code]||'').trim() : '',
          memo:  I.memo>=0  ? (r[I.memo]||'').trim() : '',
        }));
    }

    // ============ DOM ============
    const $q=document.getElementById('q'), $tbody=document.getElementById('tbody'), $count=document.getElementById('resultCount');
    const $st_ok=document.getElementById('st_ok'), $st_wip=document.getElementById('st_wip'), $st_ba=document.getElementById('st_ba');
    const $sortTitle=document.getElementById('sortTitle'), $sortArtist=document.getElementById('sortArtist');

    // 並べ替え状態
    let sortKey=null; // 'title' | 'artist' | null
    let sortDir='asc'; // 'asc' | 'desc'
    function toggleSort(which){
      if(sortKey!==which){ sortKey=which; sortDir='asc'; }
      else{ sortDir = (sortDir==='asc'?'desc':'asc'); }
      // ボタンラベル更新
      $sortTitle.textContent = '曲名 ' + (sortKey==='title' && sortDir==='desc' ? 'Z→A' : 'A→Z');
      $sortArtist.textContent = 'アーティスト ' + (sortKey==='artist' && sortDir==='desc' ? 'Z→A' : 'A→Z');
      render(filterApply(ALL));
    }

    function makeProviderButtons(title, artist){
      const wrap=document.createElement('div'); wrap.className='providers';
      PROVIDERS.forEach(p=>{
        const a=document.createElement('a');
        a.className='btn small'; a.href=p.build(title,artist); a.target='_blank'; a.rel='noopener noreferrer';
        a.title=`${p.name}で「${artist} ${title}」を検索`; a.textContent=p.name;
        wrap.appendChild(a);
      }); return wrap;
    }

    function render(list){
      // 並べ替え
      const data = sortKey ? [...list].sort((a,b)=>{
        const A=(a[sortKey]||'').toLowerCase(), B=(b[sortKey]||'').toLowerCase();
        const cmp=A.localeCompare(B,'ja'); return sortDir==='asc'?cmp:-cmp;
      }) : list;

      $tbody.innerHTML='';
      if(data.length===0){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=8; td.className='muted'; td.style.padding='20px'; td.textContent='条件に合う曲がありません。';
        tr.appendChild(td); $tbody.appendChild(tr);
      }else{
        data.forEach((row,idx)=>{
          const tr=document.createElement('tr');

          const tdNo=document.createElement('td'); tdNo.textContent=String(idx+1); tr.appendChild(tdNo);

          const tdTitle=document.createElement('td'); tdTitle.className='song';
          if(row.code){
            const a=document.createElement('a'); a.href=row.code; a.target='_blank'; a.rel='noopener noreferrer';
            a.className='title'; a.textContent=row.title||'(無題)'; tdTitle.appendChild(a);
          }else{ tdTitle.textContent=row.title||'(無題)'; }
          tr.appendChild(tdTitle);

          const tdArtist=document.createElement('td'); tdArtist.textContent=row.artist; tr.appendChild(tdArtist);

          const tdKey=document.createElement('td'); tdKey.className='nowrap';
          tdKey.innerHTML=row.key?`<span class="tag">Key: ${escapeHtml(row.key)}</span>`:''; tr.appendChild(tdKey);

          const tdState=document.createElement('td'); tdState.className='nowrap';
          tdState.innerHTML=row.state?`<span class="tag">${escapeHtml(row.state)}</span>`:''; tr.appendChild(tdState);

          const tdCode=document.createElement('td'); tdCode.className='codeurl';
          if(row.code){ const a=document.createElement('a'); a.href=row.code; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent='開く'; tdCode.appendChild(a); }
          else tdCode.innerHTML='<span class="muted">—</span>';
          tr.appendChild(tdCode);

          const tdSearch=document.createElement('td'); tdSearch.appendChild(makeProviderButtons(row.title,row.artist)); tr.appendChild(tdSearch);

          const tdMemo=document.createElement('td'); tdMemo.textContent=row.memo||''; tr.appendChild(tdMemo);

          $tbody.appendChild(tr);
        });
      }
      $count.textContent = `表示件数：${data.length}`;
    }

    function activeStates(){
      const s=[]; if($st_ok.checked) s.push('対応可'); if($st_wip.checked) s.push('練習中'); if($st_ba.checked) s.push('伴奏のみ'); return s;
    }
    function filterApply(all){
      const terms=($q.value||'').trim().split(/\s+/).filter(Boolean);
      const states=activeStates();
      return all.filter(r=>{
        if(states.length && !states.includes((r.state||'対応可'))) return false;
        if(terms.length===0) return true;
        const hay=[r.title,r.artist,r.key,r.memo,r.state].join(' ').toLowerCase();
        return terms.every(t=>hay.includes(t.toLowerCase()));
      });
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ============ 起動 ============
    let ALL=[];
    async function boot(){
      $q.value=''; // 初期は空
      try{
        const res=await fetch(CSV_PATH,{cache:'no-store'}); if(!res.ok) throw new Error('CSV取得失敗');
        const text=await res.text(); ALL=parseCSV(text);
      }catch(e){
        ALL=[]; $tbody.innerHTML=`<tr><td colspan="8" class="muted" style="padding:20px">CSV「${CSV_PATH}」が読み込めませんでした。配置とファイル名を確認してください。</td></tr>`;
        $count.textContent='表示件数：0'; return;
      }
      render(filterApply(ALL));
    }

    // イベント
    [$q,$st_ok,$st_wip,$st_ba].forEach(el=>el.addEventListener('input',()=>render(filterApply(ALL))));
    $sortTitle.addEventListener('click',()=>toggleSort('title'));
    $sortArtist.addEventListener('click',()=>toggleSort('artist'));

    boot();
  </script>

<section style="max-width:1100px;margin:32px auto;padding:0 16px">
  <h2>🎵 リクエスト募集</h2>
  <p class="muted">「この曲を弾いてほしい！」というリクエストがあれば、こちらから送ってください。</p>

  <!-- Googleフォーム埋め込み -->
  <iframe
    src="https://docs.google.com/forms/d/e/1FAIpQLSc_7e3Ihrz-KgMUAFa5VAve-1Ag41elJC9XhhKRKbuCIt09-Q/viewform?embedded=true"
    width="100%"
    height="700"
    frameborder="0"
    marginheight="0"
    marginwidth="0">
    読み込んでいます…
  </iframe>

  <!-- もし埋め込みがブロックされた場合の予備リンク -->
  <p style="margin-top:8px;">
    <a class="btn" href="https://docs.google.com/forms/d/e/1FAIpQLSc_7e3Ihrz-KgMUAFa5VAve-1Ag41elJC9XhhKRKbuCIt09-Q/viewform?usp=dialog" target="_blank" rel="noopener noreferrer">
      新しいタブでフォームを開く
    </a>
  </p>
</section>
</body>
</html>
