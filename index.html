<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>しおやんの弾き語りリスト</title>
<style>
  :root{
    --bg:#0b0c0f; --panel:#12141a; --text:#e7e9ee; --muted:#9aa3b2;
    --accent:#5ac8fa; --border:#242833; --zebra:#0f1117;
    --badge-bg:#1e2633; --badge-text:#c8d1e6;
    --stickTop: 66px; /* JSで動的に上書き */
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fb; --panel:#ffffff; --text:#0b0c0f; --muted:#5b6472; --accent:#007aff; --border:#e6e8ee; --zebra:#f3f5f9; --badge-bg:#eef2f7; --badge-text:#334155; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}

  .header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(150%) blur(8px); background:color-mix(in hsl, var(--bg) 85%, transparent); border-bottom:1px solid var(--border)}
  .header .inner{max-width:1100px; margin:auto; padding:10px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  h1{margin:0; font-size:18px}

  .pill{display:flex; align-items:center; gap:8px; border:1px solid var(--border); background:var(--panel); padding:8px 12px; border-radius:999px; flex:1}
  .pill input{all:unset; width:100%; color:var(--text)}
  .pill input::placeholder{color:var(--muted)}

  .btn{appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn.active{ border-color:var(--accent); box-shadow:0 0 0 2px color-mix(in hsl, var(--accent) 30%, transparent) inset; }

  .wrap{max-width:1100px; margin:auto; padding:12px 16px}

  .filters{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:8px 0 10px}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:13px}
  .chip input{accent-color:var(--accent)}

  .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.25)}
  table{border-collapse:collapse; width:100%}
  th,td{padding:10px 12px; text-align:left}
  td{vertical-align:middle}

  /* thead 全体を sticky（th は通常セル） */
  thead{
    position:sticky; top:var(--stickTop); z-index:10;
    background:var(--panel);
  }
  thead th{
    font-weight:600; color:var(--muted);
    border-bottom:1px solid var(--border);
    white-space:nowrap;
    background:var(--panel);
    box-shadow:0 1px 0 color-mix(in hsl, var(--border) 60%, transparent) inset;
  }

  tr:nth-child(even) td{background:var(--zebra)}
  tbody tr:hover td{background:color-mix(in hsl, var(--zebra) 70%, var(--panel))}

  .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--badge-bg); color:var(--badge-text); border:1px solid var(--border); font-size:12px}
  .link a{color:var(--accent); text-decoration:none}
  .link a:hover{text-decoration:underline}

  .side{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

  .recent{display:flex; flex-wrap:wrap; gap:8px}
  .recent .rbtn{border:1px solid var(--border); background:var(--panel); color:var(--text); padding:6px 10px; border-radius:999px; cursor:pointer}

  .quick-links { display:inline-flex; gap:.25rem; margin-left:.5rem; flex-wrap:wrap; }
  .quick-links a { font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; text-decoration:none; color:var(--text); background:var(--panel); }
</style>
</head>
<body>
  <div class="header">
    <div class="inner">
      <h1>しおやんの弾き語りリスト</h1>
      <div class="pill" style="flex:1">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6 3 11 3C15.4183 3 19 6.58 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input id="searchBox" placeholder="検索（スペース区切りでAND）"/>
      </div>
      <div class="side">
        <button id="sortTitleBtn" class="btn">曲名A→Z</button>
        <button id="sortArtistBtn" class="btn">アーティストA→Z</button>
        <label class="chip"><input id="darkToggle" type="checkbox"/> ダーク</label>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="filters" id="filters">
      <span class="chip"><input type="checkbox" id="fPractice"> 練習中</span>
      <span class="chip"><input type="checkbox" id="fOk"> 対応可</span>
      <span class="chip"><input type="checkbox" id="fEns"> 伴奏のみ</span>
      <span class="chip" id="countChip">全件数: <b id="countAll">0</b> / 表示: <b id="countShown">0</b></span>
    </div>

    <div class="card">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div style="margin-top:10px">
      <div class="chip" style="gap:8px; align-items:center">最近ひいた：
        <span id="recent" class="recent"></span>
      </div>
    </div>

    <p style="color:var(--muted); font-size:13px; margin:12px 2px">
      ※ CSVヘッダ例：<code>状態,曲名,アーティスト,ジャンル,備考,リンク先,コードURL</code>（順不同OK）  
      ※ オリジナル曲は備考に <code>オリジナル</code> と入れておけば検索でヒットします。  
      ※ 表では <code>リンク先</code> / <code>コードURL</code> 列は非表示にしています。
    </p>
  </div>

<script>
  /* ===== 正規化 ===== */
  function norm(s){
    return (s ?? '').toString().normalize('NFKC').replace(/\s+/g,' ').trim();
  }
  function toKana(s){
    return (s||'').replace(/[\u3041-\u3096]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
  }

  /* ===== CSV/TSV parser ===== */
  function parseCSV(text){
    const first = (text.split(/\r?\n/)[0]||'');
    const delim = ((first.match(/,/g)||[]).length >= (first.match(/\t/g)||[]).length) ? ',' : '\t';
    const rows=[]; let row=[], cell="", q=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch==='"'){ if(q && text[i+1]==='"'){ cell+='"'; i++; } else { q=!q; } }
      else if(ch===delim && !q){ row.push(cell); cell=""; }
      else if((ch==='\n'||ch==='\r') && !q){ if(cell!==""||row.length){ row.push(cell); rows.push(row); } row=[]; cell=""; }
      else { cell+=ch; }
    }
    if(cell!==""||row.length){ row.push(cell); rows.push(row); }
    return rows;
  }

  /* ===== State ===== */
  let rows=[];
  let titleCol=-1, noteCol=-1, stateCol=-1, artistCol=-1, linkCol=-1, codeCol=-1;

  // 並べ替え
  let sortKey = 'title';          // 'title' | 'artist'
  let sortAscTitle = true;
  let sortAscArtist = true;

  /* ===== Helpers ===== */
  function escapeHTML(s){ return (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function sanitizeURL(u){ try{ const url=new URL((u||'').trim()); if(url.protocol==='http:'||url.protocol==='https:') return url.href; }catch{} return ''; }
  function enc(s){ return encodeURIComponent(norm(s)); }
  function isOriginal(row){
    const artist = (artistCol>=0 ? toKana(norm(row[artistCol])) : '');
    const note   = (noteCol>=0 ? toKana(norm(row[noteCol]))   : '');
    return note.includes('オリジナル') || /しおやん|shioyan/i.test(artist);
  }
  function buildQuickLinks(title, artist){
    const t=norm(title); if(!t) return '';
    const q = enc(`${t} ${artist||''}`);
    const chordwiki = `https://www.google.com/search?q=site:ja.chordwiki.org+${q}`;
    const ufret     = `https://www.google.com/search?q=site:ufret.jp+${q}`;
    const jlyric    = `https://www.google.com/search?q=site:j-lyric.net+${q}`;
    return `<span class="quick-links">
      <a href="${chordwiki}" target="_blank" rel="noopener">ChordWiki検索</a>
      <a href="${ufret}"     target="_blank" rel="noopener">U-FRET検索</a>
      <a href="${jlyric}"    target="_blank" rel="noopener">歌詞検索</a>
    </span>`;
  }

  /* 最近ひいた */
  const RECENT_KEY='songlist_recent_v1';
  function pushRecent(title,url){ try{
    const list=JSON.parse(localStorage.getItem(RECENT_KEY)||'[]');
    const item={t:title,u:url,ts:Date.now()};
    const filtered=list.filter(x=>x.t!==title); filtered.unshift(item);
    localStorage.setItem(RECENT_KEY, JSON.stringify(filtered.slice(0,8)));
    renderRecent();
  }catch{} }
  function renderRecent(){ try{
    const box=document.getElementById('recent');
    const list=JSON.parse(localStorage.getItem(RECENT_KEY)||'[]');
    box.innerHTML=list.map(x=>`<button class="rbtn" onclick="openSong('${escapeHTML(x.t)}','${escapeHTML(x.u||'')}')">${escapeHTML(x.t)}</button>`).join('');
  }catch{} }
  function openSong(title,url){ if(url){ window.open(url,'_blank','noopener'); pushRecent(title,url); } }

  /* ===== Rendering ===== */
  function renderHeader(headers, showIdx){
    const h = showIdx.map(i => headers[i]);
    document.getElementById('thead').innerHTML = h.map(x=>`<th>${escapeHTML(x)}</th>`).join('');
  }

  function renderBody(data, showIdx){
    const tbody=document.getElementById('tbody');
    if(!data || data.length<=1){ tbody.innerHTML=`<tr><td colspan="99" style="color:#9aa3b2">データがありません。</td></tr>`; setCounts(0); return; }
    const rowsOnlyWithTitle = (titleCol >= 0) ? data.slice(1).filter(r => norm(r[titleCol]) !== '') : data.slice(1);

    const body = rowsOnlyWithTitle.map(r=>{
      const url     =(linkCol>=0 ? sanitizeURL(r[linkCol])  : '');
      const codeUrl =(codeCol>=0 ? sanitizeURL(r[codeCol])  : '');
      const tds = showIdx.map(i=>{
        const c = r[i] ?? '';
        if(i===titleCol){
          const title  = norm(c);
          const artist = (artistCol>=0 ? r[artistCol] : '');
          let titleHTML = escapeHTML(title);
          if (url) {
            titleHTML = `<a href="#" onclick="openSong('${escapeHTML(title)}','${url}')">${escapeHTML(title)}</a>`;
          } else if (codeUrl) {
            titleHTML = `${escapeHTML(title)} <span class="quick-links"><a href="${codeUrl}" target="_blank" rel="noopener">自分のコード</a></span>`;
          } else if (isOriginal(r)) {
            titleHTML = `${escapeHTML(title)} <span class="badge">準備中</span>`;
          } else {
            titleHTML = `${escapeHTML(title)}${buildQuickLinks(title, artist)}`;
          }
          return `<td class="link">${titleHTML}</td>`;
        } else if(i===noteCol && norm(c)!==''){
          return `<td><span class="badge">${escapeHTML(norm(c))}</span></td>`;
        } else {
          return `<td>${escapeHTML(c)}</td>`;
        }
      }).join('');
      return `<tr>${tds}</tr>`;
    }).join('');

    tbody.innerHTML = body;
    setCounts(rowsOnlyWithTitle.length);

    queueMicrotask(updateStickyTop); // 表示更新のあとに再計算
  }

  /* ===== Search / Sort / Filters ===== */
  // 検索は「曲名＋アーティスト＋備考」に限定してAND
  function applySearch(allRows, keyword){
    const k = toKana(norm(keyword));
    if(!k) return allRows;
    const kws = k.toLowerCase().split(/[\s\u3000]+/).filter(Boolean);
    const targets = [titleCol, artistCol, noteCol].filter(i => i >= 0);
    return allRows.filter((r,i)=>
      i===0 || kws.every(kw =>
        targets.some(ix => toKana(norm(r[ix] || '')).toLowerCase().includes(kw))
      )
    );
  }

  function sortRows(allRows){
    const header = allRows[0];
    const data = allRows.slice(1);
    const idx = (sortKey === 'artist' && artistCol >= 0) ? artistCol : titleCol;
    const asc = (sortKey === 'artist') ? sortAscArtist : sortAscTitle;
    if (idx < 0) return allRows;
    const sorted = data.sort((a,b)=>{
      const A = norm(a[idx]||'').toLowerCase();
      const B = norm(b[idx]||'').toLowerCase();
      const cmp = A.localeCompare(B,'ja');
      return asc ? cmp : -cmp;
    });
    return [header].concat(sorted);
  }

  function applyStateFilter(allRows){
    const selPractice = document.getElementById('fPractice').checked;
    const selOk       = document.getElementById('fOk').checked;
    const selEns      = document.getElementById('fEns').checked;
    if(!selPractice && !selOk && !selEns) return [allRows[0]];
    return [allRows[0]].concat(allRows.slice(1).filter(r=>{
      const st = (stateCol>=0 ? norm(r[stateCol]) : '');
      return (selPractice && st==='練習中') ||
             (selOk       && st==='対応可') ||
             (selEns      && st==='伴奏のみ');
    }));
  }

  function setCounts(shown){
    document.getElementById('countAll').textContent=Math.max(0,(rows.length-1));
    document.getElementById('countShown').textContent=shown;
  }

  function updateSortButtons(){
    const btnTitle  = document.getElementById('sortTitleBtn');
    const btnArtist = document.getElementById('sortArtistBtn');
    btnTitle.classList.toggle('active',  sortKey==='title');
    btnArtist.classList.toggle('active', sortKey==='artist');
    btnTitle.textContent  = `曲名${sortAscTitle?'A→Z':'Z→A'}`;
    btnArtist.textContent = `アーティスト${sortAscArtist?'A→Z':'Z→A'}`;
    btnArtist.disabled = (artistCol < 0);
    btnArtist.title = (artistCol < 0) ? 'CSVにアーティスト列が無いので使用できません' : 'アーティスト名で並べ替え';
  }

  function rerender(){
    const afterSearch  = applySearch(rows, document.getElementById('searchBox').value);
    const afterFilter  = applyStateFilter(afterSearch);
    const afterSort    = sortRows(afterFilter);
    const header = rows[0];
    let showIdx = header.map((_,i)=>i).filter(i => i!==linkCol && i!==codeCol);
    if (showIdx.length === 0) showIdx = header.map((_,i)=>i);
    renderHeader(header, showIdx);
    renderBody(afterSort, showIdx);
    updateSortButtons();
  }

  /* ===== Sticky Top（重なり防止：thead） ===== */
  // ←ここが今回の“根本対応版”
  function updateStickyTop(){
    try{
      const header  = document.querySelector('.header');   // 上のタイトル/検索バー（sticky）
      const filters = document.getElementById('filters');  // チェックボックス行（非sticky）

      // 1) ヘッダーの高さは必ず確保
      let top = (header?.offsetHeight || 0);

      // 2) 画面上で実際に“見えている”フィルタの高さぶんだけ加算
      if (filters) {
        const r = filters.getBoundingClientRect();
        const visible = Math.max(0, Math.min(r.bottom, window.innerHeight) - Math.max(r.top, 0));
        top += Math.min(visible, r.height);
      }

      // 3) 微小余白（重なり防止）
      top += 6;

      document.documentElement.style.setProperty('--stickTop', top + 'px');
    }catch(e){}
  }

  /* ===== Events ===== */
  const searchBox     = document.getElementById('searchBox');
  const darkToggle    = document.getElementById('darkToggle');
  const fPractice     = document.getElementById('fPractice');
  const fOk           = document.getElementById('fOk');
  const fEns          = document.getElementById('fEns');
  const sortTitleBtn  = document.getElementById('sortTitleBtn');
  const sortArtistBtn = document.getElementById('sortArtistBtn');

  searchBox.addEventListener('input', ()=>{ rerender(); updateStickyTop(); });
  darkToggle.addEventListener('change', ()=>{ document.documentElement.style.colorScheme=darkToggle.checked?'dark':'light'; updateStickyTop(); });
  fPractice.addEventListener('change', ()=>{ rerender(); updateStickyTop(); });
  fOk.addEventListener('change', ()=>{ rerender(); updateStickyTop(); });
  fEns.addEventListener('change', ()=>{ rerender(); updateStickyTop(); });

  sortTitleBtn.addEventListener('click', ()=>{
    if (sortKey === 'title') sortAscTitle = !sortAscTitle;
    sortKey = 'title'; rerender(); updateStickyTop();
  });
  sortArtistBtn.addEventListener('click', ()=>{
    if (sortKey === 'artist') sortAscArtist = !sortAscArtist;
    sortKey = 'artist'; rerender(); updateStickyTop();
  });

  window.addEventListener('resize', updateStickyTop);

  /* ===== Load CSV ===== */
  (function load(){
    const v=Date.now();
    fetch(encodeURI('弾き語り曲リスト.csv') + '?v=' + v).then(r=>r.text()).then(text=>{
      const parsed=parseCSV(text.trim()); if(!parsed.length) throw new Error('Empty CSV');
      rows=parsed;

      const header=rows[0].map(h => norm((h||'').toString().replace(/^\uFEFF/, '')));
      titleCol  = header.findIndex(h => /曲名|曲|タイトル|title/i.test(h));
      artistCol = header.findIndex(h => /アーティスト|歌手|artist|歌い手/i.test(h));
      noteCol   = header.findIndex(h => /備考|タグ|メモ|notes?|comment/i.test(h));
      stateCol  = header.findIndex(h => /状態|ステータス|status/i.test(h));
      linkCol   = header.findIndex(h => /リンク先|url|link|リンク/i.test(h));
      codeCol   = header.findIndex(h => /コードURL|自.?コード|譜面|score|chart|pdf/i.test(h));
      if (titleCol < 0) {
        if (stateCol === 0 && header.length > 1) titleCol = 1; else if (header.length > 1) titleCol = 0;
      }

      // 初期：3チェックON
      fPractice.checked = true; fOk.checked = true; fEns.checked = true;

      rerender();
      updateStickyTop(); // 初回計算
    }).catch(err=>{
      console.error(err);
      document.getElementById('tbody').innerHTML='<tr><td colspan="99" style="color:#9aa3b2">CSV読み込みに失敗しました。ヘッダ名とファイル名をご確認ください。</td></tr>';
    });
  })();
</script>
</body>
</html>
